---
title: "R package workshop"
format:
  gfm:
    toc: true
date: '`r Sys.Date()`'
date-format: iso
engine: knitr
---

```{r load_libraries, include=FALSE}
library(tidyverse)
```

# Introduction

This [R package workshop](https://combine-australia.github.io/r-pkg-dev/) was created by COMBINE, an association for Australian students in bioinformatics, computational biology, and related fields. It is licensed under a [Creative Commons Attribution 4.0 International (CC BY 4.0) license](https://creativecommons.org/licenses/by/4.0/).

An R package is a collection of functions that are bundled together in a way that makes it easy to share. Usually these functions are designed to work together to complete a specific task such as analysing a particular kind of data. Packages are the best way to distribute code and documentation; even if you never intend to share your package it is useful to have a place to store your commonly used functions. It's a bit more effort now but it will save you a lot of time in the long run.

This workshop teaches a modern package development workflow that makes use of packages designed to help with writing packages. The two main packages are {devtools} and {usethis}:

* {devtools} contains functions that will help with development tasks such as checking, building and installing packages.
* {usethis} contains a range of templates and handy functions for making life easier, many of which were originally in {devtools}.

Other packages used in this workshop include:

* {roxygen2} for function documentation
* {testthat} for writing unit tests
* {knitr} for building vignettes

Install the required packages for this workshop.

```{r}
#| label: required_packages
#| eval: false

pkgs <- c("devtools", "usethis", "roxygen2", "testthat", "knitr", "ggplot2", "rlang")
install.packages(pkgs, Ncpus = 2)
```

Some stages of the package development process can require other programs to be installed on your computer. To check that you have everything you need run the following:

```{r}
#| label: check_build_tools

pkgbuild::check_build_tools()
```

# Getting started

To begin building a package, we need a package name; names can only consist of letters, numbers and dots (.) and must start with a letter. While all of these are allowed it is generally best to stick to just lowercase letters. Having a mix of lower and upper case letters can be hard for users to remember (is it RColorBrewer or Rcolorbrewer or rcolorbrewer?). For this workshop, we are going to use {mypkg}.

To create a template for our package, use `usethis::create_package()`.

```{r}
#| label: create_package
#| eval: false
 
usethis::create_package(path = '/tmp/mypkg')
```

Several files get created.

```{bash}
ls -R /tmp/mypkg
```

* `DESCRIPTION` contains the metadata for your package.
* `NAMESPACE` describes the functions in our package; it should not be manually edited.
* `mypkg.Rproj` is a RStudio project file.
* `R` is the directory that will hold all our R code.

These files are the minimal amount that is required for a package but we will create other files as we go along. Some other useful (hidden) files have also been created by {usethis}:

* `.gitignore` is useful if you use `git` for version control.
* `.Rbuildignore` is used to mark files that are in the directory but arenâ€™t really part of the package and shouldn't be included when we build it. Most of the time you won't need to worry about this as {usethis} will edit it for you.

## DESCRIPTION

The `DESCRIPTION` file is one of the most important parts of a package. It contains all the metadata about the package, things like what the package is called, what version it is, a description, who the authors are, what other packages it depends on, etc.

```{bash}
cat /tmp/mypkg/DESCRIPTION
```

* The `Title` should be a single line in Title Case that explains what your package is.
* The `Description` is a paragraph which goes into a bit more detail about what the package does.

The `Authors@R` field shows an example of how to define an author. You can see that the example person has been assigned the author ("aut") and creator ("cre") roles. There must be at least one author and one creator for every package (they can be the same person) and the creator must have an email address. Other roles include:

* `cre`: the creator or maintainer of the package, the person who should be contacted when there are problems
* `aut`: authors, people who have made significant contributions to the package
* `ctb`: contributors, people who have made smaller contributions
* `cph`: copyright holder, useful if this is someone other than the creator (such as their employer)

## Functions

Use `usethis::use_r()` to create an empty file in `R` to hold our function about colours.

```{r}
#| label: use_r
#| eval: false

usethis::use_r("colours")
```

There are no rules about how to organise your functions into different files but in general similar functions should be grouped together into the same file with a clear name. Putting all functions into a single file is not ideal but neither is having a separate file for each function. A good rule of thumb is that if you are finding it hard to locate a function you might need to move it to a new file.

The example for this workshop is a function that takes the red, green and blue values for a colour and returns a given number of shades. Save the function below into `R/colours.R`.

```{r}
#| label: make_shades

make_shades <- function(colour, n, lighter = TRUE) {
  # Convert the colour to RGB
  colour_rgb <- grDevices::col2rgb(colour)[, 1]
  
  # Decide if we are heading towards white or black
  if (lighter) {
    end <- 255
  } else {
    end <- 0
  }
  
  # Calculate the red, green and blue for the shades
  # we calculate one extra point to avoid pure white/black
  red   <- seq(colour_rgb[1], end, length.out = n + 1)[1:n]
  green <- seq(colour_rgb[2], end, length.out = n + 1)[1:n]
  blue  <- seq(colour_rgb[3], end, length.out = n + 1)[1:n]
  
  # Convert the RGB values to hex codes
  shades <- grDevices::rgb(red, green, blue, maxColorValue = 255)
  
  return(shades)
}

make_shades("goldenrod", 5)
```

Usually when we write a new function we load it by copying the code to the console or sourcing the R file. When we are developing a package we want to try and keep our environment empty so that we can be sure we are only working with objects inside the package. Instead we can load functions using `devtools::load_all()`.

## License

The software license describes how our code can be used and without one people must assume that it can't be used at all! For this example we will use the MIT license which basically says the code can be used for any purpose and doesn't come with any warranties. There are templates for some of the most common licenses included in {usethis}.

```{r}
#| label: use_mit_license
#| eval: false
 
usethis::use_mit_license("Dave Tang")
```

# Session information

```{r session_info}
sessionInfo()
```
